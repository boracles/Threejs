<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chapter02_02_FoggyScene</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <!-- 성능 모니터링 도구 Stats.js 출력 영역 -->
    <div id="Stats-output"></div>
    <!-- WebGL 렌더링 출력 영역 -->
    <div id="WebGL-output"></div>

    <script type="module">
        import * as THREE from '../libs/three.module.js';
        import Stats from '../libs/stats.module.js';
        import { GUI } from '../libs/dat.gui.module.js';

        // 초기화 함수 정의
        function init() {
            const stats = initStats();

            // Three.js 장면 생성
            const scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x020202, 0.015, 100);

            // 카메라 생성
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 20, 80);
            camera.lookAt(new THREE.Vector3(0, 0, 0));

            // 렌더러 생성 및 설정
            const renderer = new THREE.WebGLRenderer();
            renderer.setClearColor(new THREE.Color(0x020202));
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; // 그림자 활성화

            // 바닥 평면 생성
            const planeGeometry = new THREE.PlaneGeometry(60, 40);
            const planeMaterial = new THREE.MeshBasicMaterial({ color: 0xB5B4A2 });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.receiveShadow = true;
            plane.rotation.x = -Math.PI / 2;
            scene.add(plane);

            // 조명 추가
            const ambientLight = new THREE.AmbientLight(0x0c0c0c, 0.2); // 은은한 주변광
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xffffff, 15, 80); // 강도 1
            pointLight.position.set(0, 10, -10); // 플레인 위쪽에서 비추도록 설정
            pointLight.castShadow = true;
            scene.add(pointLight);

            // 그림자를 시각적으로 확인할 수 있도록 PointLightHelper 추가
            const pointLightHelper = new THREE.PointLightHelper(pointLight, 5);
            scene.add(pointLightHelper);

            // 렌더러 DOM 추가
            document.getElementById('WebGL-output').appendChild(renderer.domElement);

            // 컨트롤 생성
            const controls = new function () {
                this.rotationSpeed = 0.02;
                this.numberOfObjects = scene.children.length;

                this.addCube = function () {
                    const cubeSize = Math.ceil(Math.random() * 3);
                    const cubeGeometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize);
                    const cubeMaterial = new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff });
                    const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
                    cube.castShadow = true;

                    // 랜덤 위치 설정
                    cube.position.set(
                        -30 + Math.random() * 60,
                        cubeSize / 2,
                        -20 + Math.random() * 40
                    );

                    scene.add(cube);
                    this.numberOfObjects = scene.children.length;
                };

                this.removeCube = function () {
                    const lastObject = scene.children[scene.children.length - 1];
                    if (lastObject instanceof THREE.Mesh) {
                        scene.remove(lastObject);
                        this.numberOfObjects = scene.children.length;
                    }
                };

                this.outputObjects = function () {
                    console.log(scene.children);
                };
            };

            const gui = new GUI();
            gui.add(controls, 'rotationSpeed', 0, 0.5);
            gui.add(controls, 'addCube');
            gui.add(controls, 'removeCube');
            gui.add(controls, 'outputObjects');
            gui.add(controls, 'numberOfObjects').listen();

            render();

            // 렌더링 함수
            function render() {
                stats.update();

                scene.traverse((object) => {
                    if (object instanceof THREE.Mesh && object !== plane) {
                        object.rotation.x += controls.rotationSpeed;
                        object.rotation.y += controls.rotationSpeed;
                    }
                });

                requestAnimationFrame(render);
                renderer.render(scene, camera);
            }

            // 성능 모니터링 초기화
            function initStats() {
                const stats = new Stats();
                stats.showPanel(0); // FPS
                document.getElementById('Stats-output').appendChild(stats.dom);
                return stats;
            }
        }

        // 초기화 실행
        init();
    </script>
</body>

</html>
